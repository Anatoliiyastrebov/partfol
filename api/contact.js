// Vercel Serverless Function –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
import nodemailer from 'nodemailer';

export default async function handler(req, res) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ OPTIONS –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è CORS
    if (req.method === 'OPTIONS') {
        return res.status(200).json({}).end();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ OPTIONS –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è CORS
    if (req.method === 'OPTIONS') {
        res.setHeader('Access-Control-Allow-Origin', '*');
        res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
        res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
        return res.status(200).end();
    }

    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã
    if (req.method !== 'POST') {
        res.setHeader('Access-Control-Allow-Origin', '*');
        return res.status(405).json({
            success: false,
            message: '–ú–µ—Ç–æ–¥ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ POST.'
        });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const requiredEnvVars = ['SMTP_HOST', 'SMTP_PORT', 'SMTP_USER', 'SMTP_PASS', 'EMAIL_TO'];
    const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

    if (missingVars.length > 0) {
        console.error('‚ùå –û–®–ò–ë–ö–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:', missingVars);
        res.setHeader('Access-Control-Allow-Origin', '*');
        return res.status(500).json({
            success: false,
            message: '–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.'
        });
    }

    try {
        console.log('üìß –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è');
        console.log('üìù –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(req.body, null, 2));

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        const { name, email, message } = req.body;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
        if (!name || typeof name !== 'string' || name.trim().length < 2) {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞',
                errors: ['–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞']
            });
        }

        if (name.trim().length > 100) {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: '–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤',
                errors: ['–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤']
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
        if (!email || typeof email !== 'string') {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',
                errors: ['Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω']
            });
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email.trim())) {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∞',
                errors: ['–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∞']
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (!message || typeof message !== 'string' || message.trim().length < 5) {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤',
                errors: ['–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤']
            });
        }

        if (message.trim().length > 2000) {
            res.setHeader('Access-Control-Allow-Origin', '*');
            return res.status(400).json({
                success: false,
                message: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 2000 —Å–∏–º–≤–æ–ª–æ–≤',
                errors: ['–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 2000 —Å–∏–º–≤–æ–ª–æ–≤']
            });
        }

        // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const cleanName = name.trim();
        const cleanEmail = email.trim();
        const cleanMessage = message.trim();

        console.log(`üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã: –∏–º—è="${cleanName}", email="${cleanEmail}"`);

        // –°–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
        const transporter = nodemailer.createTransport({
            host: process.env.SMTP_HOST,
            port: parseInt(process.env.SMTP_PORT, 10),
            secure: process.env.SMTP_PORT === '465', // true –¥–ª—è –ø–æ—Ä—Ç–∞ 465, false –¥–ª—è –¥—Ä—É–≥–∏—Ö
            auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS
            }
        });

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∏—Å—å–º–∞
        const mailOptions = {
            from: `"–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Å–∞–π—Ç" <${process.env.SMTP_USER}>`,
            to: process.env.EMAIL_TO,
            subject: `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –æ—Ç ${cleanName}`,
            text: `
–í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ.

–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ${cleanName}
Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ${cleanEmail}

–°–æ–æ–±—â–µ–Ω–∏–µ:
${cleanMessage}

---
–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ.
            `.trim(),
            html: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #6366f1;">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
                    <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ.</p>
                    
                    <div style="background-color: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:</strong> ${cleanName}</p>
                        <p><strong>Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:</strong> <a href="mailto:${cleanEmail}">${cleanEmail}</a></p>
                    </div>
                    
                    <div style="background-color: #ffffff; padding: 20px; border-left: 4px solid #6366f1; margin: 20px 0;">
                        <h3 style="color: #333; margin-top: 0;">–°–æ–æ–±—â–µ–Ω–∏–µ:</h3>
                        <p style="white-space: pre-wrap; color: #555;">${cleanMessage}</p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
                    <p style="color: #999; font-size: 12px;">–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ.</p>
                </div>
            `
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ email...');
        const info = await transporter.sendMail(mailOptions);
        
        console.log('‚úÖ Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        console.log(`   Message ID: ${info.messageId}`);
        console.log(`   –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${process.env.EMAIL_TO}`);

        // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        res.setHeader('Access-Control-Allow-Origin', '*');
        return res.status(200).json({
            success: true,
            message: '–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
            messageId: info.messageId
        });

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email:', error.message);
        console.error('   –î–µ—Ç–∞–ª–∏:', error);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—â–∏–π –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ (–Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
        res.setHeader('Access-Control-Allow-Origin', '*');
        return res.status(500).json({
            success: false,
            message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
        });
    }
}
